<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>RealLifeRPG Launcher v3</title>

    <script src="../config.js"></script>
    <script src="../resources/functions.js"></script>

    <script type="text/javascript">
        window.$ = window.jQuery = require('../resources/jquery/jquery-1.12.3.min.js');
    </script>

    <link rel="stylesheet" href="../resources/bootstrap/css/bootstrap.min.css">
    <script src="../resources/bootstrap/js/bootstrap.min.js"></script>

    <link href="../resources/winjs/css/ui-dark.css" rel="stylesheet" />
    <script src="../resources/winjs/js/base.js"></script>
    <script src="../resources/winjs/js/ui.js"></script>

    <link href="../resources/metroui/css/metro.min.css" rel="stylesheet">
    <link href="../resources/metroui/css/metro-icons.min.css" rel="stylesheet">
    <link href="../resources/metroui/css/metro-schemes.css" rel="stylesheet">
    <script src="../resources/metroui/js/metro.js"></script>

    <link href="../resources/tether/css/tether.min.css" rel="stylesheet">
    <script src="../resources/tether/js/tether.min.js"></script>

    <link rel="stylesheet" href="../resources/custom.css">
    <script src="index.js"></script>
</head>

<body>
    <script type="text/javascript">
        $(window).load(function() { // makes sure the whole site is loaded
            $('#status').fadeOut(); // will first fade out the loading animation
            $('#preloader').delay(350).fadeOut('slow'); // will fade out the white DIV that covers the website.
            $('body').delay(350).css({
                'overflow': 'visible'
            });
        })
    </script>
    <div id="preloader">
        <div id="status">
            <div data-role="preloader" data-type="cycle" data-style="color"></div>
        </div>
    </div>
    <div id="app">
        <div class="splitView" data-win-control="WinJS.UI.SplitView">
            <!-- Pane area -->
            <div>
                <div class="header">
                    <button class="win-splitviewpanetoggle" data-win-control="WinJS.UI.SplitViewPaneToggle" data-win-options="{ splitView: select('.splitView') }"></button>
                    <div class="title">&nbsp;</div>
                </div>

                <div class="nav-commands">
                    <div class="nav-element" data-navigate="home" data-win-control="WinJS.UI.SplitViewCommand" data-win-options="{ label: 'Home', icon: 'home'}"></div>
                    <div class="nav-element" data-navigate="server" data-win-control="WinJS.UI.SplitViewCommand" data-win-options="{ label: 'Server', icon: 'world'}"></div>
                    <div class="nav-element" data-navigate="changelog" data-win-control="WinJS.UI.SplitViewCommand" data-win-options="{ label: 'Changelog', icon: 'previewlink'}"></div>
                    <div class="nav-element" data-navigate="info" data-win-control="WinJS.UI.SplitViewCommand" data-win-options="{ label: 'Info', icon: 'contact'}"></div>
                    <div class="nav-element" data-navigate="help" data-win-control="WinJS.UI.SplitViewCommand" data-win-options="{ label: 'Hilfe', icon: 'help'}"></div>
                    <div class="nav-element" data-navigate="settings" data-win-control="WinJS.UI.SplitViewCommand" data-win-options="{ label: 'Einstellungen', icon: 'settings'}"></div>
                </div>
            </div>
            <div class="app-bar darcula" data-role="appbar">
                <div class="row" style="margin-top:0px">
                    <div class="col-md-7" style="margin-top:0px">
                        <div class="progress" id="pb1" data-value="100" data-color="bg-green" data-role="progress" style="margin-left:2%"></div>
                    </div>
                    <div class="col-md-5" id="pb1text" style="margin-top:5px">

                    </div>
                </div>
                <div class="row" style="margin-top:0px">
                    <div class="col-md-7" style="margin-top:0px">
                        <div class="progress" id="pb2" data-value="100" data-color="bg-blue" data-role="progress" style="margin-left:2%;margin-top:0px"></div>
                    </div>
                    <div class="col-md-5" id="pb2text" style="margin-bottom:5px">
                        Kein Download eingereiht.
                    </div>
                </div>
                <button onclick="var args = {message: 'stop-download',obj: {}};ipcRenderer.send('message-to-download', args);">ABBRUCH</button>
                <div class="app-bar-pullbutton automatic" style="display: none;height:48px;"></div>
                <div class="clearfix" style="width: 0;"></div>
                <nav class="app-bar-pullmenu hidden flexstyle-app-bar-menu" style="display: none;">
                    <ul class="app-bar-pullmenubar hidden app-bar-menu"></ul>
                </nav>
            </div>

            <!-- Content area -->
            <div class="contenttext" id="content"></div>
        </div>

    </div>
    </div>

    <!-- Notification Dialog -->
    <div data-role="dialog" id="dialog_notf" class="padding20 dialog success" data-close-button="true" data-type="success" style="width: auto; height: auto; visibility: visible; left: 295.5px; top: 419px;">
        <h1>Wichtige Information</h1>
        <p id="dialog_notf_text">

        </p>
        <span class="dialog-close-button"></span>
    </div>
    <!-- Arma Path Dialog -->
    <div data-role="dialog" id="dialog_defaultpath" class="padding20 dialog warning" data-type="warning" style="width: auto; height: auto; visibility: hidden; left: 289.5px; top: 419px;">
        <h1>Arma Pfad gefunden</h1>
        <p id="armapathtext">
        </p>
        <button class="button success" onclick="var pathdialog = $('#dialog_defaultpath').data('dialog');pathdialog.close();$('#content').load('home.html');enterPage = WinJS.UI.Animation.enterPage(anim, null);" style="float:left">Richtig</button>
        <button class="button danger" onclick="var pathdialog = $('#dialog_defaultpath').data('dialog');pathdialog.close();$('#content').load('settings.html');enterPage = WinJS.UI.Animation.enterPage(anim, null);" style="float:right">Falsch</button>
    </div>
    <!-- Download Complete Hash Dialog -->
    <div data-role="dialog" id="dialog_downloadComplete" class="padding20 dialog warning" data-type="warning" style="width: auto; height: auto; visibility: hidden; left: 289.5px; top: 419px;">
        <h1>Download abgeschlossen</h1>
        <p>
            Der Download ist abgeschlossen. <br/>
            Wir empfehlen eine komplette überprüfung der Mod Dateien vorzunehmen. <br/>
            Dies kann einiege Minuten dauern, dadruch ist aber sicher gestellt das der Mod korrekt geladen wurde.<br/>
        </p>
        <button class="button success" onclick="hashDialogConfirm();" style="float:right">Jetzt Prüfen</button>
        <button class="button danger" onclick="hashDialogClose();" style="float:left">Nicht Prüfen</button>
    </div>

    <!-- No Path Dialog -->
    <div data-role="dialog" id="dialog_noPath" class="padding20 dialog success" data-close-button="true" data-type="warning" style="width: auto; height: auto; visibility: visible; left: 295.5px; top: 419px;">
        <h1>Arma Pfad nicht gefunden</h1>
        <p>
            Die Aktion kann nicht ausgeführt werden, da kein Arma Pfad gefunden wurde.
        </p>
        <button class="button success" onclick="noArmaPathSettings();" style="float:right">Jetzt Einstellen</button>
    </div>
</body>

<script>
    var interval1;

    WinJS.UI.processAll().done(function() {
        var splitView = document.querySelector(".splitView").winControl;
        new WinJS.UI._WinKeyboard(splitView.paneElement); // Temporary workaround: Draw keyboard focus visuals on NavBarCommands
    });

    var anim = document.getElementById("content");
    $(".nav-element").click(function() {
        $("#content").load($(this).attr("data-navigate") + ".html");
        enterPage = WinJS.UI.Animation.enterPage(anim, null);
        curentPage = $(this).attr("data-navigate");
    });

    $("#content").load("home.html");
    curentPage = 'home';

    //TODO move to index.js since its big and ugly @greeny
    $(document).ready(function() {
        curentPage = '';
        storage.get('settings', function(error, data) {
            if (jQuery.isEmptyObject(data)) {
                regKey = new Winreg({
                    hive: Winreg.HKLM, // HKEY_LOCAL_MACHINE
                    key: '\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Steam App 107410' // Arma 3 Key
                })

                regKey.keyExists(function(err, exists /* array of RegistryItem */ ) {
                    if (exists) {
                        regKey.values(function(err, items /* array of RegistryItem */ ) {
                            path = items[3].value;
                            console.log(path);
                            try {
                                filepath = fs.lstatSync(path + "\\arma3.exe");
                                if (filepath.isFile()) {
                                    var pathdialog = $('#dialog_defaultpath').data('dialog');
                                    $('#armapathtext').html(path);
                                    pathdialog.open();
                                    path = path + "\\";
                                    storage.set('settings', {
                                        armapath: path
                                    }, function(error) {});
                                };
                            } catch (e) {
                                checkregkey2();
                            }
                        });
                    } else {
                        checkregkey2();
                    }
                });
            };
        });
    });

    function checkregkey2() {
        regKey2 = new Winreg({
            hive: Winreg.HKLM, // HKEY_LOCAL_MACHINE
            key: '\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Steam App 107410' // Arma 3 Key
        })

        regKey2.keyExists(function(err, exists /* array of RegistryItem */ ) {
            if (exists) {
                regKey2.values(function(err, items /* array of RegistryItem */ ) {
                    path = items[3].value;
                    try {
                        filepath = fs.lstatSync(path + "\\arma3.exe");
                        if (filepath.isFile()) {
                            var pathdialog = $('#dialog_defaultpath').data('dialog');
                            $('#armapathtext').html(path);
                            pathdialog.open();
                            path = path + "\\";
                            storage.set('settings', {
                                armapath: path
                            }, function(error) {});
                        };
                    } catch (e) {
                        checkregkey3();
                    }
                });
            } else {
                checkregkey3();
            }
        });
    };

    function checkregkey3() {
        regKey3 = new Winreg({
            hive: Winreg.HKLM, // HKEY_LOCAL_MACHINE
            key: '\\SOFTWARE\\WOW6432Node\\bohemia interactive studio\\ArmA 3' // Arma 3 Key
        })

        regKey3.keyExists(function(err, exists /* array of RegistryItem */ ) {
            if (exists) {
                regKey3.values(function(err, items /* array of RegistryItem */ ) {
                    path = items[0].value;
                    try {
                        filepath = fs.lstatSync(path + "\\arma3.exe");
                        if (filepath.isFile()) {
                            var pathdialog = $('#dialog_defaultpath').data('dialog');
                            $('#armapathtext').html(path);
                            pathdialog.open();
                            path = path + "\\";
                            storage.set('settings', {
                                armapath: path
                            }, function(error) {});
                        } else {
                            storage.set('settings', {
                                armapath: ''
                            }, function(error) {});
                            $('#content').load('settings.html');
                            enterPage = WinJS.UI.Animation.enterPage(anim, null);
                        }
                    } catch (e) {
                        storage.set('settings', {
                            armapath: ''
                        }, function(error) {});
                        $('#content').load('settings.html');
                        enterPage = WinJS.UI.Animation.enterPage(anim, null);
                    }
                });
            } else {
                storage.set('settings', {
                    armapath: ''
                }, function(error) {});
                $('#content').load('settings.html');
                enterPage = WinJS.UI.Animation.enterPage(anim, null);
            }
        });
    };
</script>

</html>
